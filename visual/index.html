<html>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

<head>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css"
  integrity="sha512-M2wvCLH6DSRazYeZRIm1JnYyh22purTM+FDB5CsyxtQJYeKq83arPe5wgbNmcFXGqiSH2XR8dT/fJISVA1r/zQ=="
  crossorigin=""/>

  <!-- Make sure you put this AFTER Leaflet's CSS -->
  <script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js"
  integrity="sha512-lInM/apFSqyy1o6s89K4iQUKg6ppXEgsVxT35HbzUupEVRh2Eu9Wdl4tHj7dZO0s1uvplcYGmt3498TtHq+log=="
  crossorigin=""></script>

  <style>
    #map { height: 600px; }
  </style>

 </head>
 <body>

   <h2 style="font-family:Verdana;"> Prototype of the Project for the Class Data Visualization </h2>

  <div id="map"></div>

  <script src="data/switzerland.js"></script>

  <script>

  // Assign Dummy Density and Lines
  for( var i = 0; i < swiss_data.features.length; i++ ){
    swiss_data.features[i].properties.density = i*100/30;
    swiss_data.features[i].properties.connected = [Math.abs(i-26),
                                                   Math.abs(i-20),
                                                   Math.abs(i-14),
                                                   Math.abs(i-8),
                                                   Math.abs(i-2),]
  }

  // Calculate Centers START
  function find_center(co) {
    center_x = 0;
    center_y = 0;
    for( var i = 0; i < co.length; i++ ){
      center_y += co[i][0];
      center_x += co[i][1];
    }
    return [center_x/co.length, center_y/co.length]
  }

  for( var i = 0; i < swiss_data.features.length; i++ ){
    co = swiss_data.features[i].geometry.coordinates[0][0]
    swiss_data.features[i].properties.center = find_center(co)
  }

  // Correct Faulty Centers
  swiss_data.features[21].properties.center = [46.561, 6.536] // Vaud
  swiss_data.features[10].properties.center = [47.208, 7.532] // Solothurn
  swiss_data.features[12].properties.center = [47.441, 7.764] // Basel Landschaft
  swiss_data.features[16].properties.center = [47.424, 9.376] // St. Gallen
  swiss_data.features[14].properties.center = [47.366, 9.300] // Appenzell Ausserhoden
  // Calculate Centers END

  var geojson;
  var map = L.map('map').setView([46.818, 8.227], 8);
  var mapboxAccessToken = 'pk.eyJ1IjoiMmJlb3JkaW5hcnkiLCJhIjoiY2phM2twb2wwMTAwZTMzbGZjODR2MGY5ZyJ9.ZKg4ICl_lpwgbEt5fZw5Wg';

  // Initialize Map
  L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=' + mapboxAccessToken, {
      id: 'mapbox.light',
  }).addTo(map);

  /*
  // Add Marker START
  var customIcon = L.icon({
      iconUrl: 'data/marker.png',

      iconSize:     [40, 40], // size of the icon
      iconAnchor:   [20, 35], // point of the icon which will correspond to marker's location
      popupAnchor:  [0, -30] // point from which the popup should open relative to the iconAnchor
  });

  for( var i = 0; i < swiss_data.features.length; i++ ){
    var marker = L.marker(swiss_data.features[i].properties.center, {icon: customIcon}).addTo(map);
    marker.bindPopup(swiss_data.features[i].properties.name);
  }
  // Add Marker END
  */

  // Listener START
  function highlightFeature(e) {
      var layer = e.target;

      layer.setStyle({
          weight: 1,
          color: 'black',
          opacity: 0.5,
          dashArray: '',
          fillOpacity: 0.85
      });

      if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
          layer.bringToFront();
      }
  }

  function resetHighlight(e) {
      geojson.resetStyle(e.target);
  }

  var polyLine;

  function removeLine(e) {
    try {
      map.removeLayer(polyLine);
    } catch(err) {
      // pass
    }
  }

  function drawLine(e) {
    let lines = e.target.feature.properties.connected;
    let pointList = [];

    // Add Lines
    for( var i = 0; i < lines.length; i++ ){
      let pointA = new L.LatLng(e.target.getCenter().lat, e.target.getCenter().lng);
      let pointB = new L.LatLng(swiss_data.features[lines[i]].properties.center[0],swiss_data.features[lines[i]].properties.center[1]);
      pointList.push(pointA);
      pointList.push(pointB);
    }

    // Draw Added Lines
    polyLine = new L.Polyline(pointList, {
        color: 'black',
        weight: 3,
        opacity: 0.7,
        smoothFactor: 1,
    });

    map.addLayer(polyLine);
  }

  function showName(e) {
     lat = e.target.getCenter().lat;
     lng = e.target.getCenter().lng
     var popup = L.popup()
      .setLatLng([lat,lng])
      .setContent(e.target.feature.properties.name)
      .openOn(map);
  }
  // Listener END

  // Add .geojson to the Map
  geojson = L.geoJson(swiss_data).addTo(map);

  // Color Map START
  function getColor(d) {
    return d > 90 ? '#800026' :
           d > 70 ? '#BD0026' :
           d > 50 ? '#E31A1C' :
           d > 30 ? '#FC4E2A' :
           d > 20 ? '#FD8D3C' :
           d > 10 ? '#FEB24C' :
           d > 0  ? '#FED976' :
                    '#FFEDA0';
  }

  function style(feature) {
    return {
        fillColor: getColor(feature.properties.density),
        weight: 1,
        opacity: 1,
        color: 'black',
        fillOpacity: 1
    };
  }

  function onEachFeature(feature, layer) {
      layer.on({
          mouseover: highlightFeature,
          mouseout: resetHighlight,
      });

      // layer.on({ click: showName})
      layer.on({ mouseout: removeLine})
      layer.on({ click: drawLine})
  }

  geojson = L.geoJson(swiss_data, {style: style, onEachFeature: onEachFeature}).addTo(map);
  // Color Map END

  </script>

 </body>
